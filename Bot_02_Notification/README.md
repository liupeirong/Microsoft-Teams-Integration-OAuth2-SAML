# Overview

This sample demonstrates how to build a Notification bot in Microsoft Teams. It does not delve into how
 [Teams activity handler](https://learn.microsoft.com/en-us/azure/bot-service/bot-builder-basics-teams?view=azure-bot-service-4.0&tabs=javascript)
 works yet. Rather, the motivation is to help understand how a baisc Teams bot works by explaining some of
 the things that [Teams Toolkit](https://learn.microsoft.com/en-us/microsoftteams/platform/toolkit/teams-toolkit-fundamentals?pivots=visual-studio-code),
 used in almost all tutorials, does behind the scenes.

Using the Teams Toolkit for VSCode, for example, you can [get started building a Teams bot](https://learn.microsoft.com/en-us/microsoftteams/platform/sbs-gs-bot?tabs=vscode%2Cviscode) very quickly.
 It automates a series of tasks behind `F5` to get both the bot and a Teams App registered and started.
 While it's fantastic to get things started quickly, it hides some important concepts of how things work.
 One needs to understand how things work to effectively troubleshoot and develop more advanced applications.

This sample was originally generated by creating a [Notification bot](https://learn.microsoft.com/en-us/microsoftteams/platform/sbs-gs-notificationbot?tabs=vscode) using Teams Toolkit for VSCode.  I made the following changes to help understand how it works.

## Changes to how the bot is set up

I removed the following auto-generated VSCode tasks so you perform them manually to fully understand a few key learnings.

* __Validate & install prerequisites__.
  * The key here is that you need a Microsoft 365 account to run Teams. This account can be completely different from the Azure AD account where you register an app for the bot. For example, your M365 account can be `contoso.onmicrosoft.com`, while you can register an Azure AD app for your bot in `acme.onmicrosoft.com`.
* __Install npm packages__.
* __Start local tunnel__.
  * While you don't need `ngrok` to test a vanilla bot on localhost, you do need `ngrok` to test a bot in Teams. See the [previous echo bot sample](../Bot_01_Echo/README.md) on some of the gotchas on testing the bot outside of localhost.
* __Set up bot__.
  * This task auto registers an app in Azure AD, then registers the bot in [Bot Framework dev portal](https://dev.botframework.com). When you register manually, if you have an Azure subscription, you can create the bot in Azure Bot Service; if you don't, you can create the bot by going directly to `https://dev.botframework.com/bots/new`.
  * You can also choose to register the bot as a single-tenant or multi-tenant app. More on this later.
* __Build & upload Teams manifest__.
  * A Teams app can support both Tabs and Bots, you don't have to create a Teams App manifest separately for a bot. For example, we created a [Teams App manifest in our Teams Tab sample](../Tab_02_GetMailTab/TeamsAppPackage/manifest.json). To enable this bot, all we need to do is to [add the Bot section](../Tab_02_GetMailTab/TeamsAppPackage/manifest.json#L26).
  * By default, the TeamsFx SDK creates a file `.notification.localstore.json` to store the conversation context. As you re-register the bot or the Teams App during development, this context can go out of sync and you may get an error on decrypting the conversation id. You need to delete this file, and it will be re-created when you reload the Teams App.
* `F5` will start the bot service and attaches the debugger.

## To run the bot

Go to `/repo_root/Bot_02_Notification/bot`, run `npm run dev:teamsfx`.

## Changes to the code

* Refactored the code to keep just `bot.js` and `index.js` so it's easier to compare with the [echo bot](../Bot_01_Echo/).
* This bot is created from `@microsoft/teamsfx` instead of `botbuilder` SDK. Even for notification-only bot, the message handler is still needed and handled by the TeamsFx SDK by default, for example, it handles the activity when the bot is loaded to Teams.
* TeamsFx SDK, not just this bot app, reads `BOT_ID` and `BOT_PASSWORD` environment variables, not `MicrosoftAppId` or `MicrosoftAppPassword`.
* TeamsFx doesn't run `dotenv`. Environment variables must be directly set. VSCode uses `env-cmd` to set the environment variables from an env file.

## Additional key learnings

### Should I register a multi-tenant or single-tenant Azure AD app for the bot?

First of all, why do we need to register an app for the bot? If you look at [how bots work](https://learn.microsoft.com/en-us/azure/bot-service/bot-builder-basics?view=azure-bot-service-4.0),
 a client/channel doesn't talk to your bot code directly, it goes through [Bot Framework Service](https://github.com/microsoft/BotFramework-Services)
 which talks to your bot. The Bot Framework Service talks to your bot as a confidential client using OAuth client credential flow.
 This is why you need to register an Azure AD app for your bot with app id and app secret.

At the time of this writing, C# and Javascript Bot Framework SDK [supports single-tenant app registration for bots](https://learn.microsoft.com/en-us/azure/bot-service/abs-quickstart?view=azure-bot-service-4.0&tabs=userassigned#managing-resources). Some bot capabilities are [supported based on the app type registered](https://learn.microsoft.com/en-us/azure/bot-service/abs-quickstart?view=azure-bot-service-4.0&tabs=singletenant#skill-support).

In this example, we demonstrate using a single-tenant app. Note that when you register the app using Teams Toolkit,
 it will by default register a multi-tenant app in Bot Framework dev portal and you can't change it. When you register
 it manually, you have the flexibility to choose which type of app to register, and whether in Azure or Bot Framework dev portal.

### Which Azure AD tenant should I register the bot, the Teams App, the Graph API, and where do I run the bot?

* You can register your bot in Azure AD `tenant A`. This is for the Bot Framework Service to talk to your bot. This can be either a multi-tenant or single-tenant app.
* Your Teams users can be in `tenant B` where they have Microsoft 365 license.
* Your bot can run in Azure in `tenant C` or not in Azure at all. All the Bot Framework Service needs to know is its endpoint when you registered it.
* Your bot can access, for example, Microsoft Graph API in `tenant D` as a confidential client.
* Your bot can access, for example, Microsoft Graph API [on behalf of the user](https://learn.microsoft.com/en-us/azure/bot-service/bot-builder-concept-authentication?view=azure-bot-service-4.0), by [adding authentication](https://learn.microsoft.com/en-us/azure/bot-service/bot-builder-authentication?view=azure-bot-service-4.0). If the bot is a Teams bot, it can [achieve SSO](https://learn.microsoft.com/en-us/microsoftteams/platform/bots/how-to/authentication/bot-sso-overview) because the user is already signed into Teams.
